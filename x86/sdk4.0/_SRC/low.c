/*-----------------------------------------------------------------------------

	25.07.2001	API ŒŠ-1 v 1.2.2

Œ®¤ã«ì á äã­ªæ¨ï¬¨ ­¨§ª®£® ãà®¢­ï,   â ª¦¥ äã­ªæ¨¨ ¤«ï § ¬¥­ë áâ ­¤ àâ­ëå
äã­ªæ¨© inpw, outpw.

 ------------------------------------------------------------------------------
€¢â®à: ‹ãª¨ç¥¢ €..

ˆ§¬¥­¥­¨ï:
-------- ------ ----------- --------------------------------------------------- 
 „ â 	‚¥àá¨ï	€¢â®à				¯¨á ­¨¥
-------- ------ ----------- --------------------------------------------------- 
18.08.01 1.1
20.08.01 1.2.1  Š«îç¥¢ €.. ‘¬¥­  ¢¥àá¨¨
19.09.01 1.2.2  Š«îç¥¢ €.. ¯â¨¬¨§¨à®¢ ­ë äã­ªæ¨¨ ¢¢®¤ -¢ë¢®¤  (inpw, outpw)
		¯® ¡ëáâà®¤¥©áâ¢¨î

-----------------------------------------------------------------------------*/

#include "186es.h"
#include "mpkdefs.h"
#include "low.h"

/* ----------------------------------------------------------------------------
			setvect
   ----------------------------------------------------------------------------
“áâ ­®¢ª  ®¡à ¡®âç¨ª  ¯à¥àë¢ ­¨ï

¥§ã«ìâ â	  -	0 ¢ á«ãç ¥ ãá¯¥å ;
			1 ¢ á«ãç ¥ ­¥ã¤ ç¨ (­¥¯à ¢¨«ì­ë© ­®¬¥à ¯à¥àë¢ ­¨ï,
			­¥¯à ¢¨«ì­ë© (NULL)  ¤à¥á ®¡à ¡®âç¨ª ).
‚å®¤­ë¥ ¯ à ¬¥âàë -	intnum - ­®¬¥à ¯à¥àë¢ ­¨ï
			handler - ¤ «ì­¨© ãª § â¥«ì ­  äã­ªæ¨î-®¡à ¡®âç¨ª
 ---------------------------------------------------------------------------- */

BYTE setvect( BYTE intnum, void (__interrupt __far *handler)() )
{
DWORD far * isr_table = (DWORD far *)0x00000000l;
	if( (intnum==0x9) || ((intnum>0x15) && (intnum<0x1F)) ) return 1;
	if( !handler ) return 1;
	isr_table[intnum] = (DWORD)handler;
	return 0;
}

/* ----------------------------------------------------------------------------
			outpw
   ----------------------------------------------------------------------------

”ã­ªæ¨ï § ¯¨á¨ 16-â¨ à §àï¤­®£® á«®¢  ¢ ¯®àâ ¢¢®¤ -¢ë¢®¤ 

¥§ã«ìâ â	  -	¥â
‚å®¤­ë¥ ¯ à ¬¥âàë -	addr -  ¤à¥á ¯®àâ 
			data - § ¯¨áë¢ ¥¬®¥ á«®¢®
 ---------------------------------------------------------------------------- */

// ‘¬. ä ©« low.h

/* ----------------------------------------------------------------------------
			inpw
   ----------------------------------------------------------------------------

”ã­ªæ¨ï çâ¥­¨ï 16-â¨ à §àï¤­®£® á«®¢  ¨§ ¯®àâ  ¢¢®¤ -¢ë¢®¤ 

¥§ã«ìâ â	  -	16-â¨ à §àï¤­®¥ á«®¢® ¤ ­­ëå
‚å®¤­ë¥ ¯ à ¬¥âàë -	addr -  ¤à¥á ¯®àâ 
 ---------------------------------------------------------------------------- */

// ‘¬. ä ©« low.h

/* ----------------------------------------------------------------------------
			EnInterrupt
   ----------------------------------------------------------------------------

”ã­ªæ¨ï ¤«ï à §à¥è¥­¨ï ¯à¥àë¢ ­¨© ¯® ¬ áª¥

¥§ã«ìâ â	  -	¥â
‚å®¤­ë¥ ¯ à ¬¥âàë -	mask
			mask - ¬ áª  (¡¨â=1 à §à¥è¥­¨¥ ¯à¥àë¢ ­¨ï)
 ---------------------------------------------------------------------------- */

void EnInterrupt(WORD mask)
{
	outpw(IMASK,inpw(IMASK)&~mask);
}

/* ----------------------------------------------------------------------------
			DiInterrupt
   ----------------------------------------------------------------------------

”ã­ªæ¨ï ¤«ï § ¯à¥é¥­¨ï ¯à¥àë¢ ­¨© ¯® ¬ áª¥

¥§ã«ìâ â	  -	¥â
‚å®¤­ë¥ ¯ à ¬¥âàë -	mask
			mask - ¬ áª  (¡¨â=1 § ¯à¥é¥­¨¥ ¯à¥àë¢ ­¨ï)
 ---------------------------------------------------------------------------- */
void DiInterrupt(WORD mask)
{
	outpw(IMASK,inpw(IMASK)|mask);
}

/* ----------------------------------------------------------------------------
			Stop
   ----------------------------------------------------------------------------

áâ ­®¢ª  á¨áâ¥¬ë

¥§ã«ìâ â	  -	¥â
‚å®¤­ë¥ ¯ à ¬¥âàë -	¥â

¯¨á ­¨¥:
”ã­ªæ¨ï ¯®¢¨á ¥â ¢ ¡¥áª®­¥ç­®¬ æ¨ª«¥. WDT ¯®áâ®ï­­® á¡à áë¢ ¥âáï. ¥®¡å®¤¨¬  ¯à¨ 
®â« ¤ª¥.

 ---------------------------------------------------------------------------- */
extern void ResetWDT(void);

void Stop(void)
{
	di();
	while ( 1 )
		ResetWDT();
}


/* ----------------------------------------------------------------------------
			InitWDT
   ----------------------------------------------------------------------------

ˆ­¨æ¨ «¨§ æ¨ï áâ®à®¦¥¢®£® â ©¬¥à  (WatchDog-â ©¬¥à ).

¥§ã«ìâ â	  -	¥â
‚å®¤­ë¥ ¯ à ¬¥âàë -	¥â

¯¨á ­¨¥:
”ã­ªæ¨ï ¨­¨æ¨ «¨§¨àã¥â WDT. InitWDT ¢ë§ë¢ ¥âáï ¨§ äã­ªæ¨¨ Init() 

 ---------------------------------------------------------------------------- */

void InitWDT(void)
{
	outpw(WDTCON,0x3333);	// ¯®á«¥¤®¢ â¥«ì­®áâì ¤«ï § ¯¨á¨ ¢ WDTCON
	outpw(WDTCON,0xCCCC);
	outpw(WDTCON,0xC080);//ƒ¥­¥à¨à®¢ âì Reset ¯® ¨áâ¥ç¥­¨¨ ~3.5 á¥ªã­¤
}

